<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>Timelapse Overlay</title>
<style>

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RESET & VARIABLES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

*, *::before, *::after {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  -webkit-tap-highlight-color: transparent;
  -webkit-touch-callout: none;
}

:root {
  --safe-top:    env(safe-area-inset-top,    44px);
  --safe-bottom: env(safe-area-inset-bottom, 34px);
  --accent:  #0A84FF;
  --yellow:  #FFD60A;
  --danger:  #FF453A;
  --surface: rgba(28, 28, 30, 0.94);
  --text:    #ffffff;
  --text2:   rgba(255, 255, 255, 0.55);
}

html {
  height: -webkit-fill-available;
  /* FIX: prevent pull-to-refresh in Safari */
  overscroll-behavior: none;
}

body {
  width: 100%;
  height: 100vh;
  height: -webkit-fill-available;
  overflow: hidden;
  position: fixed;
  top: 0; left: 0;
  background: #000;
  color: var(--text);
  font-family: -apple-system, 'Helvetica Neue', sans-serif;
  /* FIX: prevent bounce/pull-to-refresh on touch */
  touch-action: none;
  overscroll-behavior: none;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SCREEN SYSTEM
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

.screen {
  position: fixed;
  inset: 0;
  height: 100vh;
  height: -webkit-fill-available;
  display: none;
  background: #000;
}
.screen.active { display: flex; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   START SCREEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

#screen-start {
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 40px 32px;
  padding-top:    calc(var(--safe-top)    + 20px);
  padding-bottom: calc(var(--safe-bottom) + 20px);
  gap: 0;
}

.app-icon {
  width: 88px;
  height: 88px;
  background: linear-gradient(145deg, #1c1c1e, #2c2c2e);
  border-radius: 20px;
  display: flex;
  align-items: center;
  justify-content: center;
  margin-bottom: 22px;
  box-shadow: 0 8px 32px rgba(0,0,0,0.5), inset 0 1px 0 rgba(255,255,255,0.07);
}

.app-title {
  font-size: 26px;
  font-weight: 700;
  letter-spacing: -0.5px;
  margin-bottom: 10px;
}

.app-subtitle {
  font-size: 15px;
  color: var(--text2);
  text-align: center;
  line-height: 1.5;
  max-width: 270px;
  margin-bottom: 48px;
}

.btn {
  width: 100%;
  max-width: 300px;
  padding: 16px;
  border: none;
  border-radius: 13px;
  font-size: 17px;
  font-weight: 600;
  color: #fff;
  cursor: pointer;
  letter-spacing: -0.2px;
  transition: opacity 0.1s;
}
.btn:active { opacity: 0.65; }
.btn-primary   { background: var(--accent); }
.btn-secondary { background: rgba(255,255,255,0.12); margin-top: 12px; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PERMISSION SCREEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

#screen-permission {
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 40px 32px;
  text-align: center;
  gap: 12px;
}

#screen-permission .perm-icon { font-size: 60px; margin-bottom: 8px; }
#screen-permission h2 { font-size: 22px; font-weight: 700; }
#screen-permission p  { color: var(--text2); font-size: 15px; line-height: 1.5; max-width: 270px; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CAMERA SCREEN
   Note: flex-direction not set â€” children
   are absolutely positioned layers.
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

#screen-camera {
  position: fixed;
  inset: 0;
  overflow: hidden;
  /* FIX: allow touch events inside but block overscroll */
  touch-action: none;
}

/* Layer 1: Video */
#video {
  position: absolute;
  inset: 0;
  width: 100%;
  height: 100%;
  object-fit: cover;
  background: #000;
  /* GPU compositing layer prevents black frames */
  transform: translateZ(0);
  -webkit-transform: translateZ(0);
}

/* Layer 2: Overlay image
   MUST use same object-fit as video for pixel-perfect alignment */
#overlay-img {
  position: absolute;
  inset: 0;
  width: 100%;
  height: 100%;
  object-fit: cover;        /* matches video â€” same crop, same scale */
  object-position: center;  /* matches video default */
  opacity: 0.5;
  pointer-events: none;
  display: none;
  transform: translateZ(0);
  -webkit-transform: translateZ(0);
}

/* Layer 3: Shutter flash */
#flash {
  position: absolute;
  inset: 0;
  background: #fff;
  opacity: 0;
  pointer-events: none;
  z-index: 20;
  transition: opacity 0.07s;
}

/* Layer 4: Top bar */
#top-bar {
  position: absolute;
  top: 0; left: 0; right: 0;
  z-index: 10;
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: calc(var(--safe-top) + 10px) 16px 18px;
  background: linear-gradient(to bottom, rgba(0,0,0,0.55), transparent);
}

.icon-btn {
  width: 40px;
  height: 40px;
  border: none;
  background: none;
  color: #fff;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  flex-shrink: 0;
}
.icon-btn:active { background: rgba(255,255,255,0.2); }

#opacity-badge {
  background: rgba(0,0,0,0.5);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  border-radius: 20px;
  padding: 5px 14px;
  font-size: 13px;
  font-weight: 600;
  color: var(--yellow);
  min-width: 52px;
  text-align: center;
  /* Hidden when no overlay loaded */
}

/* Layer 5: No-overlay hint */
#no-overlay-hint {
  position: absolute;
  bottom: 200px;
  left: 50%;
  transform: translateX(-50%);
  z-index: 5;
  background: rgba(0,0,0,0.52);
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
  border-radius: 14px;
  padding: 12px 18px;
  text-align: center;
  pointer-events: none;
  white-space: nowrap;
}
#no-overlay-hint p {
  font-size: 13px;
  color: rgba(255,255,255,0.75);
  line-height: 1.5;
}

/* Layer 6: Bottom controls */
#bottom-controls {
  position: absolute;
  bottom: 0; left: 0; right: 0;
  z-index: 10;
  background: linear-gradient(to top, rgba(0,0,0,0.7) 0%, transparent 100%);
  padding-bottom: calc(var(--safe-bottom) + 6px);
}

/* Opacity slider row */
#slider-row {
  display: none; /* shown only when overlay is loaded */
  align-items: center;
  padding: 0 24px 14px;
  gap: 12px;
}

.slider-icon { flex-shrink: 0; opacity: 0.5; }

input[type="range"] {
  -webkit-appearance: none;
  flex: 1;
  height: 4px;
  background: rgba(255,255,255,0.28);
  border-radius: 2px;
  outline: none;
  cursor: pointer;
  /* Allow horizontal drag on iOS (overrides body touch-action:none) */
  touch-action: pan-x;
}
input[type="range"]::-webkit-slider-thumb {
  -webkit-appearance: none;
  width: 24px;
  height: 24px;
  border-radius: 50%;
  background: #fff;
  box-shadow: 0 2px 8px rgba(0,0,0,0.4);
}

/* Shutter row â€” 3-column layout */
#shutter-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 36px 10px;
}

/* Left: thumbnail of last photo */
#last-photo-btn {
  width: 58px;
  height: 58px;
  border-radius: 12px;
  border: 2px solid rgba(255,255,255,0.45);
  background: rgba(255,255,255,0.08);
  overflow: hidden;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
  transition: opacity 0.1s;
}
#last-photo-btn:active { opacity: 0.6; }
#last-photo-img { width: 100%; height: 100%; object-fit: cover; display: none; }
#last-photo-icon { display: flex; opacity: 0.5; }

/* Center: shutter button */
#shutter-btn {
  width: 78px;
  height: 78px;
  border: none;
  background: transparent;
  cursor: pointer;
  padding: 0;
  flex-shrink: 0;
  transition: transform 0.08s;
}
#shutter-btn:active { transform: scale(0.91); }

.shutter-ring {
  width: 100%;
  height: 100%;
  border-radius: 50%;
  border: 4px solid #fff;
  display: flex;
  align-items: center;
  justify-content: center;
}
.shutter-fill {
  width: 63px;
  height: 63px;
  border-radius: 50%;
  background: #fff;
}

/* Right: load reference image */
#load-ref-btn {
  width: 58px;
  height: 58px;
  border-radius: 50%;
  border: none;
  background: rgba(255,255,255,0.13);
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  color: #fff;
  flex-shrink: 0;
  transition: background 0.1s;
}
#load-ref-btn:active { background: rgba(255,255,255,0.28); }

/* Hidden inputs */
#ref-input { display: none; }
#canvas    { display: none; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SAVE FALLBACK SCREEN
   Shown when Web Share API is unavailable
   (file:// protocol, older iOS, non-HTTPS).

   Strategy: show the photo fullscreen.
   iOS native long-press menu on an <img>
   always includes "Bild sichern" regardless
   of protocol â€” no extra permissions needed.
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

#screen-save {
  flex-direction: column;
  background: #000;
  /* This screen must allow touch on the image */
  touch-action: auto;
}

/* The photo â€” fills screen, long-press saves it */
#save-preview-img {
  flex: 1;
  width: 100%;
  object-fit: contain;
  background: #000;
  display: block;
  /* CRITICAL: re-enable iOS long-press context menu */
  -webkit-touch-callout: default;
  touch-action: auto;
  user-select: auto;
  -webkit-user-select: auto;
}

/* Pulsing ring animation to draw attention */
@keyframes pulse-ring {
  0%   { transform: translate(-50%, -50%) scale(0.92); opacity: 0.9; }
  50%  { transform: translate(-50%, -50%) scale(1.08); opacity: 0.4; }
  100% { transform: translate(-50%, -50%) scale(0.92); opacity: 0.9; }
}

/* Overlay hint on the image */
#save-hint-overlay {
  position: absolute;
  /* Centered in the image area (above the bar) */
  bottom: calc(100px + var(--safe-bottom));
  left: 50%;
  transform: translateX(-50%);
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 10px;
  pointer-events: none; /* let touches pass through to the image */
  z-index: 10;
}

.save-hint-ring {
  width: 72px;
  height: 72px;
  border-radius: 50%;
  border: 3px solid rgba(255,255,255,0.7);
  position: relative;
}
.save-hint-ring::after {
  content: '';
  position: absolute;
  inset: -8px;
  border-radius: 50%;
  border: 3px solid rgba(255,255,255,0.35);
  animation: pulse-ring 1.6s ease-in-out infinite;
}
.save-hint-finger {
  font-size: 36px;
  line-height: 1;
  filter: drop-shadow(0 2px 4px rgba(0,0,0,0.6));
}

.save-hint-text {
  background: rgba(0,0,0,0.65);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  border-radius: 14px;
  padding: 8px 16px;
  text-align: center;
}
.save-hint-text strong {
  display: block;
  font-size: 15px;
  font-weight: 700;
  color: #fff;
  margin-bottom: 2px;
}
.save-hint-text span {
  font-size: 12px;
  color: rgba(255,255,255,0.6);
}

/* Bottom bar */
#save-bar {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 14px 20px calc(var(--safe-bottom) + 14px);
  background: var(--surface);
  border-top: 0.5px solid rgba(255,255,255,0.1);
  flex-shrink: 0;
  gap: 12px;
}

#save-back-btn {
  background: rgba(255,255,255,0.12);
  color: #fff;
  border: none;
  border-radius: 10px;
  padding: 12px 20px;
  font-size: 15px;
  font-weight: 500;
  cursor: pointer;
  transition: opacity 0.1s;
}
#save-back-btn:active { opacity: 0.65; }

#save-share-btn {
  background: var(--accent);
  color: #fff;
  border: none;
  border-radius: 10px;
  padding: 12px 20px;
  font-size: 15px;
  font-weight: 600;
  cursor: pointer;
  transition: opacity 0.1s;
  flex: 1;
}
#save-share-btn:active { opacity: 0.65; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TOAST NOTIFICATIONS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

#toast {
  position: fixed;
  top: calc(var(--safe-top) + 58px);
  left: 50%;
  transform: translateX(-50%) translateY(-8px);
  background: rgba(30,30,32,0.92);
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
  border-radius: 20px;
  padding: 8px 18px;
  font-size: 14px;
  font-weight: 500;
  color: #fff;
  white-space: nowrap;
  z-index: 100;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.18s, transform 0.18s;
}
#toast.visible {
  opacity: 1;
  transform: translateX(-50%) translateY(0);
}

</style>
</head>
<body>

<!-- â•â•â•â•â•â• START â•â•â•â•â•â• -->
<div id="screen-start" class="screen active">
  <div class="app-icon">
    <svg width="50" height="50" viewBox="0 0 50 50" fill="none">
      <circle cx="25" cy="20" r="9" stroke="#FFD60A" stroke-width="2"/>
      <circle cx="25" cy="20" r="4"  fill="#FFD60A" opacity="0.4"/>
      <path d="M8 43c0-9.94 8.06-18 17-18s17 8.06 17 18" stroke="white" stroke-width="2" stroke-linecap="round"/>
    </svg>
  </div>
  <div class="app-title">Timelapse Overlay</div>
  <div class="app-subtitle">Ãœberlagere die Kamera mit einem Referenzfoto fÃ¼r konsistente Aufnahmen.</div>
  <button class="btn btn-primary" id="btn-start">Kamera starten</button>
</div>

<!-- â•â•â•â•â•â• PERMISSION ERROR â•â•â•â•â•â• -->
<div id="screen-permission" class="screen">
  <div class="perm-icon">ğŸ“·</div>
  <h2>Kamerazugriff benÃ¶tigt</h2>
  <p>Bitte erlaube den Kamerazugriff in den iPhone-Einstellungen und versuche es erneut.</p>
  <button class="btn btn-primary" id="btn-retry" style="margin-top:24px; max-width:240px">
    Erneut versuchen
  </button>
  <button class="btn btn-secondary" id="btn-perm-back" style="max-width:240px">
    ZurÃ¼ck
  </button>
</div>

<!-- â•â•â•â•â•â• CAMERA â•â•â•â•â•â• -->
<div id="screen-camera" class="screen">

  <!-- Video stream -->
  <video id="video" autoplay playsinline muted></video>

  <!-- Reference image overlay -->
  <img id="overlay-img" alt="">

  <!-- Shutter flash -->
  <div id="flash"></div>

  <!-- Top bar -->
  <div id="top-bar">
    <button class="icon-btn" id="btn-close-camera" aria-label="SchlieÃŸen">
      <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
        <path d="M2 2l12 12M14 2L2 14" stroke="white" stroke-width="2.2" stroke-linecap="round"/>
      </svg>
    </button>

    <div id="opacity-badge" style="visibility:hidden">50%</div>

    <!-- Spacer for symmetry -->
    <div style="width:40px"></div>
  </div>

  <!-- Hint: shown when no overlay loaded -->
  <div id="no-overlay-hint">
    <p>Referenzbild laden â†’</p>
  </div>

  <!-- Bottom controls -->
  <div id="bottom-controls">

    <!-- Opacity slider â€” only visible when overlay is active -->
    <div id="slider-row">
      <svg class="slider-icon" width="18" height="18" viewBox="0 0 18 18" fill="none">
        <circle cx="9" cy="9" r="4" stroke="white" stroke-width="1.5"/>
      </svg>
      <input type="range" id="opacity-slider" min="0" max="100" value="50"
             aria-label="Transparenz des Referenzbildes">
      <svg class="slider-icon" width="18" height="18" viewBox="0 0 18 18" fill="none">
        <circle cx="9" cy="9" r="7" stroke="white" stroke-width="1.5"/>
        <circle cx="9" cy="9" r="3" fill="white"/>
      </svg>
    </div>

    <!-- Main buttons -->
    <div id="shutter-row">

      <!-- Last captured photo thumbnail -->
      <button id="last-photo-btn" aria-label="Letztes Foto">
        <img id="last-photo-img" alt="Letztes Foto">
        <span id="last-photo-icon">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
            <rect x="2" y="6" width="15" height="12" rx="2" stroke="white" stroke-width="1.5"/>
            <path d="M19 9.5l3-2v9l-3-2v-5z" stroke="white" stroke-width="1.5" stroke-linejoin="round"/>
          </svg>
        </span>
      </button>

      <!-- Shutter -->
      <button id="shutter-btn" aria-label="Foto aufnehmen">
        <div class="shutter-ring">
          <div class="shutter-fill"></div>
        </div>
      </button>

      <!-- Load reference image -->
      <button id="load-ref-btn" aria-label="Referenzbild laden">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
          <rect x="3" y="3" width="18" height="18" rx="2.5" stroke="white" stroke-width="1.5"/>
          <path d="M12 15V9M9 12l3-3 3 3" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M8 18h8" stroke="white" stroke-width="1.5" stroke-linecap="round"/>
        </svg>
      </button>

    </div>
  </div>

  <!-- File inputs -->
  <input type="file" id="ref-input" accept="image/*">
  <canvas id="canvas"></canvas>

</div>

<!-- â•â•â•â•â•â• SAVE FALLBACK â•â•â•â•â•â• -->
<!--
  Shown when navigator.share({files}) is unavailable (file:// protocol).
  The <img> element gets iOS native long-press menu with "Bild sichern".
  -webkit-touch-callout:default and touch-action:auto are required on the img.
-->
<div id="screen-save" class="screen">
  <img id="save-preview-img" alt="Aufnahme">

  <!-- Animated hint (pointer-events:none so touches reach the image below) -->
  <div id="save-hint-overlay">
    <div class="save-hint-ring">
      <div style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;">
        <span class="save-hint-finger">ğŸ‘†</span>
      </div>
    </div>
    <div class="save-hint-text">
      <strong>GedrÃ¼ckt halten</strong>
      <span>â†’ "Bild sichern" wÃ¤hlen</span>
    </div>
  </div>

  <div id="save-bar">
    <button id="save-back-btn">â† ZurÃ¼ck</button>
    <button id="save-share-btn">ğŸ“¤ Teilen</button>
  </div>
</div>

<!-- Toast -->
<div id="toast" role="status" aria-live="polite"></div>

<script>
'use strict';

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MODULE: UI HELPERS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

const UI = (() => {
  const $ = id => document.getElementById(id);
  let toastTimer = null;

  function showScreen(id) {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    $(id).classList.add('active');
  }

  function showToast(message, duration = 2200) {
    const el = $('toast');
    el.textContent = message;
    el.classList.add('visible');
    clearTimeout(toastTimer);
    toastTimer = setTimeout(() => el.classList.remove('visible'), duration);
  }

  // Prevent pull-to-refresh and rubber-banding.
  // Exceptions: range inputs (sliders) need touchmove to work.
  function lockScroll() {
    document.addEventListener('touchmove', e => {
      // Allow touchmove on range inputs so the slider can be dragged
      if (e.target.closest('input[type="range"]')) return;
      e.preventDefault();
    }, { passive: false });
  }

  function dataUrlToBlob(dataUrl) {
    const [header, data] = dataUrl.split(',');
    const mime   = header.match(/:(.*?);/)[1];
    const bytes  = atob(data);
    const buffer = new Uint8Array(bytes.length);
    for (let i = 0; i < bytes.length; i++) buffer[i] = bytes.charCodeAt(i);
    return new Blob([buffer], { type: mime });
  }

  return { $, showScreen, showToast, lockScroll, dataUrlToBlob };
})();

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MODULE: CAMERA
   Responsibility: manage MediaStream lifecycle
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

const Camera = (() => {
  const { $, showScreen, showToast } = UI;
  let stream = null;

  async function start() {
    // Always stop previous stream first
    stop();

    // Minimal constraints: let iOS pick the best config.
    // Width/height ideals often cause black frames on iOS.
    const constraints = {
      video: { facingMode: { ideal: 'environment' } },
      audio: false
    };

    try {
      stream = await navigator.mediaDevices.getUserMedia(constraints);
      const video = $('video');
      video.srcObject = stream;
      // Explicit play() required by iOS Safari after srcObject assignment
      await video.play();
      showScreen('screen-camera');
    } catch (err) {
      console.error('[Camera] start failed:', err.name, err.message);
      showScreen('screen-permission');
    }
  }

  function stop() {
    if (!stream) return;
    stream.getTracks().forEach(t => t.stop());
    stream = null;
    const video = $('video');
    video.srcObject = null;
  }

  function isActive() {
    return stream !== null;
  }

  // Restart on visibility restore (app comes back from background)
  document.addEventListener('visibilitychange', () => {
    const camActive = document.getElementById('screen-camera').classList.contains('active');
    if (!document.hidden && camActive) {
      const video = $('video');
      if (!stream) {
        start();
      } else if (video.paused) {
        video.play().catch(() => {});
      }
    }
  });

  // Guard against stalled video (rare on iOS)
  document.getElementById('video').addEventListener('stalled', () => {
    const video = $('video');
    if (stream) {
      video.srcObject = stream;
      video.play().catch(() => {});
    }
  });

  return { start, stop, isActive };
})();

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MODULE: OVERLAY
   Responsibility: load and display reference image
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

const Overlay = (() => {
  const { $, showToast } = UI;
  const MAX_DIMENSION = 4096; // Resize above this to avoid iOS memory pressure
  let loaded = false;

  function load(file) {
    if (!file) return;

    const reader = new FileReader();
    reader.onerror = () => showToast('Fehler beim Laden des Bildes');
    reader.onload = e => {
      const img = new Image();
      img.onerror = () => showToast('UngÃ¼ltiges Bildformat');
      img.onload = () => {
        const src = _maybeResize(img, e.target.result);
        _apply(src);
      };
      img.src = e.target.result;
    };
    reader.readAsDataURL(file);
  }

  function _maybeResize(img, originalSrc) {
    if (img.width <= MAX_DIMENSION && img.height <= MAX_DIMENSION) {
      return originalSrc;
    }
    const scale = Math.min(MAX_DIMENSION / img.width, MAX_DIMENSION / img.height);
    const cv = document.createElement('canvas');
    cv.width  = Math.round(img.width  * scale);
    cv.height = Math.round(img.height * scale);
    cv.getContext('2d').drawImage(img, 0, 0, cv.width, cv.height);
    return cv.toDataURL('image/jpeg', 0.9);
  }

  function _apply(src) {
    const el = $('overlay-img');
    el.src = src;
    el.style.display = 'block';
    loaded = true;

    // Show opacity slider and badge
    $('slider-row').style.display = 'flex';
    $('opacity-badge').style.visibility = 'visible';
    $('no-overlay-hint').style.display = 'none';

    showToast('âœ“ Referenzbild geladen');
  }

  function setOpacity(value) {
    $('overlay-img').style.opacity = value / 100;
    $('opacity-badge').textContent  = `${value}%`;
  }

  function isLoaded() { return loaded; }

  return { load, setOpacity, isLoaded };
})();

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MODULE: CAPTURE
   Responsibility: take photo, save to Photos

   iOS Save Strategy:
   1. navigator.share({files}) called WITHIN the shutter
      click handler (same user gesture = share sheet opens
      immediately, no second tap required).
   2. If share API is unavailable (non-HTTPS, older iOS):
      show fallback screen where user long-presses to save.

   Canvas crop logic:
   The video element uses object-fit:cover, which scales the
   stream to fill the element and crops the excess. To capture
   exactly what is visible (not the full uncropped stream), we
   calculate the same crop and apply it via drawImage src params.
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

const Capture = (() => {
  const { $, showScreen, showToast, dataUrlToBlob } = UI;
  let lastDataUrl  = null;
  let lastFilename = null;

  // Called directly from shutter button click (user gesture required for share)
  async function shoot() {
    const video = $('video');

    if (!video.videoWidth || !video.videoHeight) {
      showToast('Kamera noch nicht bereit â€“ bitte kurz warten');
      return;
    }

    const dataUrl  = _captureFrame(video);
    const filename = _generateFilename();

    lastDataUrl  = dataUrl;
    lastFilename = filename;

    _triggerFlash();
    _updateThumbnail(dataUrl);

    // Attempt to save. Must be called here (same gesture stack as shutter tap).
    await _save(dataUrl, filename);
  }

  // Re-share the last captured photo (thumbnail tap)
  async function reshareLastPhoto() {
    if (!lastDataUrl) {
      showToast('Noch kein Foto aufgenommen');
      return;
    }
    await _save(lastDataUrl, lastFilename);
  }

  // â”€â”€ Private â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  function _captureFrame(video) {
    const canvas = $('canvas');

    // Screen dimensions (what is actually visible)
    const screenW = video.offsetWidth;
    const screenH = video.offsetHeight;

    // Raw camera stream dimensions
    const streamW = video.videoWidth;
    const streamH = video.videoHeight;

    // object-fit:cover scale factor: fills screen, crops excess
    const coverScale = Math.max(screenW / streamW, screenH / streamH);

    // Rendered stream size after cover scale
    const renderedW = streamW * coverScale;
    const renderedH = streamH * coverScale;

    // Pixel offset of the crop (centred)
    const cropOffsetX = (renderedW - screenW) / 2;
    const cropOffsetY = (renderedH - screenH) / 2;

    // Source rectangle in original stream coordinates
    const srcX = cropOffsetX / coverScale;
    const srcY = cropOffsetY / coverScale;
    const srcW = screenW    / coverScale;
    const srcH = screenH    / coverScale;

    // Output canvas = screen pixel size (1:1 with what user sees)
    canvas.width  = screenW;
    canvas.height = screenH;

    canvas.getContext('2d').drawImage(video, srcX, srcY, srcW, srcH, 0, 0, screenW, screenH);

    return canvas.toDataURL('image/jpeg', 0.95);
  }

  function _generateFilename() {
    const now  = new Date();
    const pad  = n => String(n).padStart(2, '0');
    return `timelapse_${now.getFullYear()}-${pad(now.getMonth()+1)}-${pad(now.getDate())}_${pad(now.getHours())}${pad(now.getMinutes())}${pad(now.getSeconds())}.jpg`;
  }

  function _triggerFlash() {
    const flash = $('flash');
    flash.style.opacity = 1;
    setTimeout(() => { flash.style.opacity = 0; }, 80);
  }

  function _updateThumbnail(dataUrl) {
    $('last-photo-img').src     = dataUrl;
    $('last-photo-img').style.display  = 'block';
    $('last-photo-icon').style.display = 'none';
  }

  async function _save(dataUrl, filename) {
    // On file:// protocol, navigator.share({files}) is always blocked by iOS.
    // Skip straight to the visual fallback to avoid a confusing error flash.
    const isFileProtocol = location.protocol === 'file:';

    if (!isFileProtocol && typeof navigator.share === 'function') {
      try {
        const blob = dataUrlToBlob(dataUrl);
        const file = new File([blob], filename, { type: 'image/jpeg' });
        await navigator.share({ files: [file], title: 'Timelapse Foto' });
        // Share sheet opened â€” "In Fotos sichern" is one tap inside it.
        return;
      } catch (err) {
        if (err.name === 'AbortError') {
          // User cancelled the share sheet â€” stay on camera, do nothing.
          return;
        }
        // Other error (e.g. file sharing not supported on this browser):
        // fall through to visual fallback below.
        console.warn('[Capture] share failed:', err.name, err.message);
      }
    }

    // Fallback: show photo fullscreen so user can long-press â†’ "Bild sichern".
    // This works on ALL iOS versions and protocols â€” it uses the native
    // Safari image context menu, which always includes "Bild sichern".
    $('save-preview-img').src = dataUrl;
    showScreen('screen-save');
  }

  return { shoot, reshareLastPhoto, getLastDataUrl: () => lastDataUrl, getLastFilename: () => lastFilename };
})();

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MODULE: APP
   Responsibility: wire events, bootstrap
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

const App = (() => {
  const { $, showScreen, showToast, lockScroll, dataUrlToBlob } = UI;

  function init() {
    lockScroll();
    _bindEvents();
  }

  function _bindEvents() {
    // Start screen
    $('btn-start').addEventListener('click', () => Camera.start());

    // Permission screen
    $('btn-retry').addEventListener('click',     () => Camera.start());
    $('btn-perm-back').addEventListener('click', () => showScreen('screen-start'));

    // Camera: close
    $('btn-close-camera').addEventListener('click', () => {
      Camera.stop();
      showScreen('screen-start');
    });

    // Camera: shutter â€” async handler, share call is within this gesture
    $('shutter-btn').addEventListener('click', () => {
      Capture.shoot();
    });

    // Camera: load reference image
    $('load-ref-btn').addEventListener('click', () => $('ref-input').click());
    $('ref-input').addEventListener('change', e => {
      Overlay.load(e.target.files[0]);
      e.target.value = ''; // reset so same file can be reselected
    });

    // Camera: opacity slider
    $('opacity-slider').addEventListener('input', e => {
      Overlay.setOpacity(parseInt(e.target.value, 10));
    });

    // Camera: thumbnail tap â†’ reshare last photo
    $('last-photo-btn').addEventListener('click', () => Capture.reshareLastPhoto());

    // Save fallback screen
    $('save-back-btn').addEventListener('click', () => {
      $('save-preview-img').src = '';
      showScreen('screen-camera');
    });

    // "Teilen" button on fallback screen â€” retry share (works if user was on file://
    // and has since navigated, or to try the system share sheet directly)
    $('save-share-btn').addEventListener('click', async () => {
      const dataUrl  = Capture.getLastDataUrl();
      const filename = Capture.getLastFilename();
      if (!dataUrl) return;
      if (typeof navigator.share === 'function') {
        try {
          const blob = dataUrlToBlob(dataUrl);
          const file = new File([blob], filename, { type: 'image/jpeg' });
          await navigator.share({ files: [file], title: 'Timelapse Foto' });
        } catch (err) {
          if (err.name !== 'AbortError') {
            UI.showToast('Teilen nicht verfÃ¼gbar â€“ bitte lang drÃ¼cken');
          }
        }
      } else {
        UI.showToast('Bitte Bild lang gedrÃ¼ckt halten â†’ "Bild sichern"');
      }
    });
  }

  return { init };
})();

// Bootstrap
App.init();
</script>
</body>
</html>
