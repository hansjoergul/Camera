<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>Timelapse Overlay</title>
<style>
/* â”€â”€ Reset & base â”€â”€ */
*, *::before, *::after {
  margin: 0; padding: 0; box-sizing: border-box;
  -webkit-tap-highlight-color: transparent;
  -webkit-touch-callout: none;
}

:root {
  --safe-top: env(safe-area-inset-top, 44px);
  --safe-bottom: env(safe-area-inset-bottom, 34px);
  --accent: #0A84FF;
  --yellow: #FFD60A;
  --danger: #FF453A;
  --surface: rgba(28,28,30,0.92);
  --text: #fff;
  --text2: rgba(255,255,255,0.55);
  --border: rgba(255,255,255,0.12);
}

html, body {
  width: 100%; height: 100%;
  overflow: hidden;
  background: #000;
  color: var(--text);
  font-family: -apple-system, 'SF Pro Display', 'Helvetica Neue', sans-serif;
  position: fixed; top: 0; left: 0;
  /* Prevent address bar issues on mobile */
  height: -webkit-fill-available;
}

/* â”€â”€ Screen management â”€â”€ */
.screen {
  position: fixed; inset: 0;
  display: none;
  background: #000;
  /* Full height including notch */
  height: 100vh;
  height: -webkit-fill-available;
}
.screen.active { display: block; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   START SCREEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#startScreen {
  display: none;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 0;
  padding: 40px 30px;
  padding-top: calc(var(--safe-top) + 20px);
  padding-bottom: calc(var(--safe-bottom) + 20px);
}
#startScreen.active { display: flex; }

.app-icon {
  width: 88px; height: 88px;
  background: linear-gradient(150deg, #1c1c1e 0%, #2c2c2e 100%);
  border-radius: 20px;
  display: flex; align-items: center; justify-content: center;
  margin-bottom: 20px;
  box-shadow: 0 8px 32px rgba(0,0,0,0.6), inset 0 1px 0 rgba(255,255,255,0.08);
}

.app-title {
  font-size: 26px; font-weight: 700;
  letter-spacing: -0.5px;
  margin-bottom: 8px;
}
.app-sub {
  font-size: 14px; color: var(--text2);
  text-align: center; line-height: 1.5;
  margin-bottom: 44px;
  max-width: 280px;
}

.btn {
  width: 100%; max-width: 300px;
  padding: 16px;
  border: none; border-radius: 13px;
  font-size: 17px; font-weight: 600;
  color: #fff;
  cursor: pointer;
  transition: opacity 0.12s;
  letter-spacing: -0.2px;
}
.btn:active { opacity: 0.7; transform: scale(0.98); }
.btn-primary { background: var(--accent); }
.btn-secondary { background: rgba(255,255,255,0.12); margin-top: 12px; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PERMISSION SCREEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#permScreen {
  display: none;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 40px;
  text-align: center;
  gap: 12px;
}
#permScreen.active { display: flex; }
.perm-emoji { font-size: 64px; margin-bottom: 8px; }
#permScreen h2 { font-size: 22px; font-weight: 700; }
#permScreen p { color: var(--text2); font-size: 15px; line-height: 1.5; max-width: 280px; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CAMERA SCREEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#camScreen {
  /* block, not flex â€“ children are absolutely positioned */
}

/* â”€â”€ Video: fills entire screen â”€â”€ */
#video {
  position: absolute; inset: 0;
  width: 100%; height: 100%;
  object-fit: cover;
  background: #000;
  /* Critical for iOS Safari */
  -webkit-transform: translateZ(0);
  transform: translateZ(0);
}

/* â”€â”€ Overlay image: centered, contained â”€â”€ */
#overlayImg {
  position: absolute;
  top: 0; left: 0;
  width: 100%; height: 100%;
  object-fit: contain;
  opacity: 0.5;
  pointer-events: none;
  display: none;
  -webkit-transform: translateZ(0);
  transform: translateZ(0);
}

/* â”€â”€ Shutter flash â”€â”€ */
#flash {
  position: absolute; inset: 0;
  background: #fff;
  opacity: 0;
  pointer-events: none;
  z-index: 20;
  transition: opacity 0.06s;
}

/* â”€â”€ Top bar â”€â”€ */
#topBar {
  position: absolute;
  top: 0; left: 0; right: 0;
  z-index: 10;
  padding: calc(var(--safe-top) + 10px) 16px 16px;
  display: flex; align-items: center; justify-content: space-between;
  background: linear-gradient(to bottom, rgba(0,0,0,0.55) 0%, transparent 100%);
}

.icon-btn {
  width: 40px; height: 40px;
  border: none; background: none;
  color: #fff; cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  border-radius: 50%;
  flex-shrink: 0;
}
.icon-btn:active { background: rgba(255,255,255,0.18); }

#opacityLabel {
  background: rgba(0,0,0,0.52);
  backdrop-filter: blur(12px) saturate(1.5);
  -webkit-backdrop-filter: blur(12px) saturate(1.5);
  border-radius: 20px;
  padding: 5px 14px;
  font-size: 13px; font-weight: 600;
  color: var(--yellow);
  min-width: 52px; text-align: center;
}

/* â”€â”€ No-overlay hint â”€â”€ */
#noOverlayHint {
  position: absolute;
  top: 50%; left: 50%;
  transform: translate(-50%, -50%);
  z-index: 5;
  background: rgba(0,0,0,0.5);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  border-radius: 14px;
  padding: 14px 20px;
  text-align: center;
  pointer-events: none;
}
#noOverlayHint p { font-size: 14px; color: rgba(255,255,255,0.7); line-height: 1.4; }
#noOverlayHint .hint-arrow {
  font-size: 24px; margin-top: 6px;
}

/* â”€â”€ Bottom controls â”€â”€ */
#bottomControls {
  position: absolute;
  bottom: 0; left: 0; right: 0;
  z-index: 10;
  background: linear-gradient(to top, rgba(0,0,0,0.72) 0%, transparent 100%);
  padding-bottom: calc(var(--safe-bottom) + 4px);
}

/* Slider row */
#sliderRow {
  display: flex; align-items: center;
  padding: 0 24px 12px;
  gap: 12px;
}
.slider-icon { flex-shrink: 0; opacity: 0.55; }

input[type=range] {
  -webkit-appearance: none;
  flex: 1; height: 4px;
  background: rgba(255,255,255,0.28);
  border-radius: 2px;
  outline: none;
  cursor: pointer;
}
input[type=range]::-webkit-slider-thumb {
  -webkit-appearance: none;
  width: 24px; height: 24px;
  border-radius: 50%;
  background: #fff;
  box-shadow: 0 2px 8px rgba(0,0,0,0.35);
}

/* Shutter row */
#shutterRow {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 36px 10px;
}

/* Gallery button â†’ opens native picker */
#galleryBtn {
  width: 58px; height: 58px;
  border-radius: 12px;
  border: 2px solid rgba(255,255,255,0.45);
  background: rgba(255,255,255,0.08);
  overflow: hidden;
  cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  transition: opacity 0.12s;
}
#galleryBtn:active { opacity: 0.6; }
#galleryThumbImg {
  width: 100%; height: 100%; object-fit: cover; display: none;
}
#galleryIcon { display: flex; }

/* Shutter */
#shutterBtn {
  width: 78px; height: 78px;
  border: none; background: transparent;
  cursor: pointer; padding: 0;
  transition: transform 0.08s;
  flex-shrink: 0;
}
#shutterBtn:active { transform: scale(0.92); }
.shutter-ring {
  width: 100%; height: 100%;
  border-radius: 50%;
  border: 4px solid #fff;
  display: flex; align-items: center; justify-content: center;
}
.shutter-fill {
  width: 63px; height: 63px;
  border-radius: 50%;
  background: #fff;
}

/* Upload overlay btn */
#uploadBtn {
  width: 58px; height: 58px;
  border-radius: 50%;
  border: none;
  background: rgba(255,255,255,0.14);
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
  display: flex; align-items: center; justify-content: center;
  cursor: pointer;
  color: #fff;
  transition: background 0.12s;
}
#uploadBtn:active { background: rgba(255,255,255,0.28); }

/* Hidden inputs */
#overlayInput, #saveInput { display: none; }

/* â”€â”€ Toast â”€â”€ */
#toast {
  position: fixed;
  top: calc(var(--safe-top) + 60px);
  left: 50%; transform: translateX(-50%) translateY(-10px);
  background: rgba(30,30,32,0.9);
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
  border-radius: 20px;
  padding: 8px 18px;
  font-size: 14px; font-weight: 500;
  color: #fff;
  z-index: 100;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.2s, transform 0.2s;
  white-space: nowrap;
}
#toast.show {
  opacity: 1;
  transform: translateX(-50%) translateY(0);
}

/* â”€â”€ Rotate animation â”€â”€ */
@keyframes spin180 {
  from { transform: rotate(0deg); }
  to   { transform: rotate(180deg); }
}
.spin { animation: spin180 0.35s ease forwards; }

/* â”€â”€ Overlay active badge â”€â”€ */
#overlayActiveBadge {
  position: absolute;
  top: calc(var(--safe-top) + 62px);
  left: 50%;
  transform: translateX(-50%);
  z-index: 10;
  background: rgba(0,0,0,0.5);
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
  border-radius: 20px;
  padding: 4px 12px;
  font-size: 12px; color: var(--yellow); font-weight: 600;
  pointer-events: none;
  display: none;
}

/* â”€â”€ Canvas (off-screen) â”€â”€ */
#canvas { display: none; }
</style>
</head>
<body>

<!-- â•â•â•â• START SCREEN â•â•â•â• -->
<div id="startScreen" class="screen active">
  <div class="app-icon">
    <svg width="50" height="50" viewBox="0 0 50 50" fill="none">
      <circle cx="25" cy="20" r="9" stroke="#FFD60A" stroke-width="2.2"/>
      <circle cx="25" cy="20" r="4" fill="#FFD60A" opacity="0.4"/>
      <path d="M7 43c0-9.94 8.06-18 18-18s18 8.06 18 18" stroke="white" stroke-width="2.2" stroke-linecap="round"/>
      <rect x="33" y="6" width="13" height="9" rx="1.5" stroke="white" stroke-width="1.8"/>
      <circle cx="39.5" cy="10.5" r="2" fill="#0A84FF"/>
    </svg>
  </div>
  <div class="app-title">Timelapse Overlay</div>
  <div class="app-sub">Ãœberlagere deine Kamera mit einem Referenzfoto â€“ so bleiben alle Aufnahmen perfekt ausgerichtet.</div>
  <button class="btn btn-primary" id="startBtn">Kamera starten</button>
</div>

<!-- â•â•â•â• PERMISSION SCREEN â•â•â•â• -->
<div id="permScreen" class="screen">
  <div class="perm-emoji">ğŸ“·</div>
  <h2>Kamerazugriff benÃ¶tigt</h2>
  <p>Bitte erlaube den Kamerazugriff in deinen Einstellungen und versuche es erneut.</p>
  <button class="btn btn-primary" id="retryBtn" style="margin-top:20px;max-width:240px">Erneut versuchen</button>
  <button class="btn btn-secondary" id="permBackBtn" style="max-width:240px">ZurÃ¼ck</button>
</div>

<!-- â•â•â•â• CAMERA SCREEN â•â•â•â• -->
<div id="camScreen" class="screen">
  <!-- Video layer -->
  <video id="video" autoplay playsinline muted></video>

  <!-- Overlay layer -->
  <img id="overlayImg" alt="Referenz">

  <!-- Flash -->
  <div id="flash"></div>

  <!-- Overlay active badge -->
  <div id="overlayActiveBadge">Referenzbild aktiv</div>

  <!-- No overlay hint -->
  <div id="noOverlayHint">
    <p>Kein Referenzbild geladen.<br>Tippe â†˜ um eines hinzuzufÃ¼gen.</p>
    <div class="hint-arrow">â†˜</div>
  </div>

  <!-- Top bar -->
  <div id="topBar">
    <button class="icon-btn" id="backBtn">
      <!-- X icon -->
      <svg width="18" height="18" viewBox="0 0 18 18" fill="none">
        <path d="M4 4l10 10M14 4L4 14" stroke="white" stroke-width="2" stroke-linecap="round"/>
      </svg>
    </button>
    <div id="opacityLabel">50%</div>
    <button class="icon-btn" id="rotateBtn" title="Ausrichtung">
      <svg id="rotateIcon" width="24" height="24" viewBox="0 0 24 24" fill="none">
        <path d="M3 12C3 7.03 7.03 3 12 3c2.77 0 5.25 1.24 6.95 3.2" stroke="white" stroke-width="2" stroke-linecap="round"/>
        <path d="M21 12c0 4.97-4.03 9-9 9-2.77 0-5.25-1.24-6.95-3.2" stroke="white" stroke-width="2" stroke-linecap="round"/>
        <path d="M18.95 1.5v4.7h-4.7" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="M5.05 22.5v-4.7h4.7" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </button>
  </div>

  <!-- Bottom controls -->
  <div id="bottomControls">
    <!-- Opacity slider (only when overlay loaded) -->
    <div id="sliderRow" style="display:none">
      <!-- min icon -->
      <svg class="slider-icon" width="18" height="18" viewBox="0 0 18 18" fill="none">
        <circle cx="9" cy="9" r="4" stroke="white" stroke-width="1.5"/>
      </svg>
      <input type="range" id="opacitySlider" min="0" max="100" value="50">
      <!-- max icon -->
      <svg class="slider-icon" width="18" height="18" viewBox="0 0 18 18" fill="none">
        <circle cx="9" cy="9" r="7" stroke="white" stroke-width="1.5"/>
        <circle cx="9" cy="9" r="3" fill="white"/>
      </svg>
    </div>

    <!-- Shutter row -->
    <div id="shutterRow">
      <!-- Gallery: opens last photo in native viewer / file picker for reference -->
      <button id="galleryBtn" title="Letzte Aufnahme ansehen">
        <img id="galleryThumbImg" alt="">
        <span id="galleryIcon">
          <svg width="26" height="26" viewBox="0 0 26 26" fill="none">
            <rect x="2" y="7" width="16" height="13" rx="2.5" stroke="rgba(255,255,255,0.5)" stroke-width="1.5"/>
            <path d="M20 10.5l4-2.5v10l-4-2.5v-5z" stroke="rgba(255,255,255,0.5)" stroke-width="1.5" stroke-linejoin="round"/>
          </svg>
        </span>
      </button>

      <!-- Shutter -->
      <button id="shutterBtn">
        <div class="shutter-ring">
          <div class="shutter-fill"></div>
        </div>
      </button>

      <!-- Upload reference overlay -->
      <button id="uploadBtn" title="Referenzbild laden">
        <svg width="26" height="26" viewBox="0 0 26 26" fill="none">
          <rect x="3" y="3" width="20" height="20" rx="3" stroke="white" stroke-width="1.5"/>
          <path d="M13 17V10M10 13l3-3 3 3" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M9 20h8" stroke="white" stroke-width="1.5" stroke-linecap="round"/>
        </svg>
      </button>
    </div>
  </div>

  <!-- Hidden file inputs -->
  <!-- Reference image overlay: from gallery/files -->
  <input type="file" id="overlayInput" accept="image/*">
  <!-- For opening last captured photo in device gallery -->
  <input type="file" id="viewLastInput" accept="image/*" capture>

  <!-- Hidden canvas for capture -->
  <canvas id="canvas"></canvas>
</div>

<!-- â•â•â•â• TOAST â•â•â•â• -->
<div id="toast"></div>

<script>
'use strict';

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   UTILITIES
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const $ = id => document.getElementById(id);

function showToast(msg, duration = 2200) {
  const t = $('toast');
  t.textContent = msg;
  t.classList.add('show');
  clearTimeout(showToast._timer);
  showToast._timer = setTimeout(() => t.classList.remove('show'), duration);
}

function dataUrlToBlob(dataUrl) {
  const [header, data] = dataUrl.split(',');
  const mime = header.match(/:(.*?);/)[1];
  const binary = atob(data);
  const arr = new Uint8Array(binary.length);
  for (let i = 0; i < binary.length; i++) arr[i] = binary.charCodeAt(i);
  return new Blob([arr], { type: mime });
}

function getFilename() {
  const now = new Date();
  const p = n => String(n).padStart(2,'0');
  return `timelapse_${now.getFullYear()}-${p(now.getMonth()+1)}-${p(now.getDate())}_${p(now.getHours())}${p(now.getMinutes())}${p(now.getSeconds())}.jpg`;
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   SCREEN MANAGER
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const screens = ['startScreen','permScreen','camScreen'];

function showScreen(id) {
  screens.forEach(s => $( s).classList.remove('active'));
  $(id).classList.add('active');
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   CAMERA MODULE
   
   Fix: simplified constraints, explicit play(),
   GPU composite layer (translateZ), no dimension constraints
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const Camera = {
  stream: null,

  async start() {
    const video = $('video');

    // Stop any existing stream
    Camera.stop();

    const constraints = {
      video: {
        facingMode: { ideal: 'environment' }
        // No width/height ideal â€“ let browser pick best
      },
      audio: false
    };

    try {
      const stream = await navigator.mediaDevices.getUserMedia(constraints);
      Camera.stream = stream;
      video.srcObject = stream;

      // Must explicitly call play() on iOS Safari after setting srcObject
      await video.play();

      showScreen('camScreen');
    } catch (err) {
      console.error('Camera error:', err.name, err.message);
      showScreen('permScreen');
    }
  },

  stop() {
    if (Camera.stream) {
      Camera.stream.getTracks().forEach(t => t.stop());
      Camera.stream = null;
    }
    const v = $('video');
    v.srcObject = null;
  }
};

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   OVERLAY MODULE
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const Overlay = {
  loaded: false,

  load(file) {
    if (!file) return;
    const reader = new FileReader();
    reader.onload = e => {
      const img = new Image();
      img.onload = () => {
        // Resize if > 4096px to avoid memory issues on mobile
        const MAX = 4096;
        if (img.width > MAX || img.height > MAX) {
          const cv = document.createElement('canvas');
          const r = Math.min(MAX / img.width, MAX / img.height);
          cv.width = Math.round(img.width * r);
          cv.height = Math.round(img.height * r);
          cv.getContext('2d').drawImage(img, 0, 0, cv.width, cv.height);
          Overlay._apply(cv.toDataURL('image/jpeg', 0.9));
        } else {
          Overlay._apply(e.target.result);
        }
      };
      img.src = e.target.result;
    };
    reader.readAsDataURL(file);
  },

  _apply(src) {
    const el = $('overlayImg');
    el.src = src;
    el.style.display = 'block';
    Overlay.loaded = true;

    // Show slider
    $('sliderRow').style.display = 'flex';

    // Show badge briefly
    const badge = $('overlayActiveBadge');
    badge.style.display = 'block';
    setTimeout(() => badge.style.display = 'none', 2500);

    // Hide hint
    $('noOverlayHint').style.display = 'none';

    showToast('âœ“ Referenzbild geladen');
  },

  setOpacity(val) {
    $('overlayImg').style.opacity = val / 100;
    $('opacityLabel').textContent = `${val}%`;
  }
};

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   CAPTURE MODULE
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const Capture = {
  lastDataUrl: null,
  lastFilename: null,

  async shoot() {
    const video = $('video');
    const canvas = $('canvas');

    if (!video.videoWidth) {
      showToast('Kamera nicht bereit');
      return;
    }

    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    const ctx = canvas.getContext('2d');

    // Flip if front camera (not used here, but defensive)
    ctx.drawImage(video, 0, 0);

    const filename = getFilename();
    const dataUrl = canvas.toDataURL('image/jpeg', 0.95);
    Capture.lastDataUrl = dataUrl;
    Capture.lastFilename = filename;

    // Flash effect
    const flash = $('flash');
    flash.style.opacity = 1;
    setTimeout(() => flash.style.opacity = 0, 80);

    // Update gallery thumbnail
    const thumbImg = $('galleryThumbImg');
    thumbImg.src = dataUrl;
    thumbImg.style.display = 'block';
    $('galleryIcon').style.display = 'none';

    // Save to device
    await Capture.saveToDevice(dataUrl, filename);
  },

  async saveToDevice(dataUrl, filename) {
    const blob = dataUrlToBlob(dataUrl);
    const file = new File([blob], filename, { type: 'image/jpeg' });

    // Web Share API â€“ opens iOS share sheet â†’ user can "In Fotos sichern"
    if (navigator.canShare && navigator.canShare({ files: [file] })) {
      try {
        await navigator.share({
          files: [file],
          title: 'Timelapse Aufnahme'
        });
        showToast('âœ“ Gespeichert');
      } catch (err) {
        if (err.name !== 'AbortError') {
          // User cancelled or share failed, fallback to download
          Capture._fallbackDownload(dataUrl, filename);
        }
      }
    } else {
      // Fallback for non-supporting browsers
      Capture._fallbackDownload(dataUrl, filename);
    }
  },

  _fallbackDownload(dataUrl, filename) {
    const a = document.createElement('a');
    a.href = dataUrl;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    showToast('âœ“ Foto heruntergeladen');
  },

  // Re-share last photo (tapping gallery thumb)
  async shareLastPhoto() {
    if (!Capture.lastDataUrl) {
      showToast('Noch kein Foto aufgenommen');
      return;
    }
    await Capture.saveToDevice(Capture.lastDataUrl, Capture.lastFilename);
  }
};

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   ORIENTATION MODULE
   
   Fix: screen.orientation.lock only in fullscreen (not available
   in Safari). Instead we just show a toast about rotating the phone.
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const OrientationCtrl = {
  toggle() {
    const icon = $('rotateIcon');
    icon.classList.remove('spin');
    // Trigger reflow
    void icon.offsetWidth;
    icon.classList.add('spin');
    setTimeout(() => icon.classList.remove('spin'), 400);

    showToast('Drehe dein iPhone um 90Â°', 2000);
  }
};

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   EVENT WIRING
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

// Start screen
$('startBtn').addEventListener('click', () => Camera.start());

// Permission screen
$('retryBtn').addEventListener('click', () => Camera.start());
$('permBackBtn').addEventListener('click', () => {
  Camera.stop();
  showScreen('startScreen');
});

// Back to start
$('backBtn').addEventListener('click', () => {
  Camera.stop();
  $('overlayImg').src = '';
  $('overlayImg').style.display = 'none';
  $('noOverlayHint').style.display = 'block';
  $('sliderRow').style.display = 'none';
  $('opacitySlider').value = 50;
  $('opacityLabel').textContent = '50%';
  $('galleryThumbImg').style.display = 'none';
  $('galleryThumbImg').src = '';
  $('galleryIcon').style.display = 'flex';
  Overlay.loaded = false;
  Capture.lastDataUrl = null;
  Capture.lastFilename = null;
  showScreen('startScreen');
});

// Shutter
$('shutterBtn').addEventListener('click', () => Capture.shoot());

// Upload reference overlay
$('uploadBtn').addEventListener('click', () => $('overlayInput').click());
$('overlayInput').addEventListener('change', e => {
  Overlay.load(e.target.files[0]);
  e.target.value = ''; // reset so same file can be re-selected
});

// Gallery thumb â†’ share/save last photo
$('galleryBtn').addEventListener('click', () => Capture.shareLastPhoto());

// Opacity slider
$('opacitySlider').addEventListener('input', e => {
  Overlay.setOpacity(parseInt(e.target.value));
});

// Rotate hint
$('rotateBtn').addEventListener('click', () => OrientationCtrl.toggle());

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   VIDEO STALL WATCHDOG
   If video stops rendering (black screen), restart
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const video = $('video');
video.addEventListener('loadedmetadata', () => {
  video.play().catch(err => console.warn('Play error:', err));
});
video.addEventListener('stalled', () => {
  console.warn('Video stalled â€“ attempting restart');
  if (Camera.stream) {
    video.srcObject = Camera.stream;
    video.play().catch(() => {});
  }
});

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   VISIBILITY CHANGE
   Restore camera when app comes back to foreground
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
document.addEventListener('visibilitychange', () => {
  if (!document.hidden && $('camScreen').classList.contains('active')) {
    if (!Camera.stream) {
      Camera.start();
    } else if (video.paused) {
      video.play().catch(() => {});
    }
  }
});
</script>
</body>
</html>
